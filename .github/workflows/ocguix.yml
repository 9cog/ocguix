# OpenCog Guix Package Build with Caching and Artifact Generation

name: ocguix

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  ocguix:

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug - List repository files
        run: |
          echo "Current directory:"
          pwd
          echo "Files in current directory:"
          ls -la
          echo "Checking for opencog.scm:"
          ls -l opencog.scm || echo "opencog.scm not found"

      - name: Cache Guix store
        uses: actions/cache@v4
        with:
          path: |
            /var/guix
            ~/.cache/guix
          key: guix-store-${{ runner.os }}-${{ hashFiles('opencog.scm') }}
          restore-keys: |
            guix-store-${{ runner.os }}-

      - name: Install GNU Guix
        run: |
          sudo apt-get update
          sudo apt-get install -y guix
          
          # Display Guix version
          guix --version
          
          # Initialize Guix if needed
          sudo mkdir -p /var/guix
          sudo chown -R $USER:$USER /var/guix || true

      - name: Restore Guix daemon state
        run: |
          echo "Checking Guix store state..."
          if [ -d "/var/guix/profiles" ]; then
            echo "Guix store cache restored"
            du -sh /var/guix 2>/dev/null || echo "Unable to check size"
          else
            echo "No cache found, will download all dependencies"
          fi

      - name: Build OpenCog packages
        run: |
          echo "Building OpenCog package..."
          echo "This will download and cache all dependencies..."
          guix build -f opencog.scm
          echo "Build completed successfully!"

      - name: Display Guix store statistics
        run: |
          echo "Guix store statistics:"
          guix gc --list-dead 2>/dev/null | wc -l || echo "Dead items: N/A"
          guix gc --list-live 2>/dev/null | wc -l || echo "Live items: N/A"
          du -sh /var/guix 2>/dev/null || echo "Store size: N/A"

      - name: Export package manifest
        run: |
          echo "Exporting package manifest..."
          guix package --export-manifest > opencog-manifest.scm || echo "specifications->manifest" > opencog-manifest.scm
          echo "Manifest content:"
          cat opencog-manifest.scm

      - name: Get build output path
        id: build_output
        run: |
          echo "Getting build output path..."
          BUILD_PATH=$(guix build -f opencog.scm)
          echo "Build path: $BUILD_PATH"
          echo "build_path=$BUILD_PATH" >> $GITHUB_OUTPUT

      - name: Create package archive
        run: |
          echo "Creating package archive..."
          mkdir -p artifacts
          cd artifacts
          
          # Create tarball from build output
          BUILD_PATH="${{ steps.build_output.outputs.build_path }}"
          if [ -n "$BUILD_PATH" ] && [ -d "$BUILD_PATH" ]; then
            echo "Packaging $BUILD_PATH..."
            tar -czf opencog-pack.tar.gz -C "$BUILD_PATH" .
          else
            echo "Build path not found, creating placeholder"
            echo "OpenCog build output not available" > README.txt
            tar -czf opencog-pack.tar.gz README.txt
          fi
          
          cd ..
          ls -lh artifacts/

      - name: Generate build info
        run: |
          echo "Generating build information..."
          cat > artifacts/build-info.txt << EOF
          OpenCog Guix Package Build
          ==========================
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Git Commit: ${GITHUB_SHA}
          Git Branch: ${GITHUB_REF#refs/heads/}
          Workflow Run: ${GITHUB_RUN_NUMBER}
          Runner OS: $(uname -a)
          Build Output Path: ${{ steps.build_output.outputs.build_path }}
          
          Guix Version:
          -------------
          $(guix --version)
          
          Build Command Used:
          ------------------
          guix build -f opencog.scm
          
          Cache Status:
          ------------
          Cache was used for dependencies (if available from previous builds)
          All downloaded sources and built packages are cached for future runs
          
          Package Definition:
          ------------------
          See opencog-package-definition.scm in artifacts
          EOF
          cat artifacts/build-info.txt

      - name: Copy files to artifacts
        run: |
          cp opencog-manifest.scm artifacts/ 2>/dev/null || echo "No manifest to copy"
          cp opencog.scm artifacts/opencog-package-definition.scm
          
          # Try to get package info
          guix package --show=opencog > artifacts/package-info.txt 2>&1 || echo "Package info not available via guix package --show" > artifacts/package-info.txt

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: opencog-guix-packages
          path: |
            artifacts/
          retention-days: 90
          compression-level: 9

      - name: Upload package definition separately
        uses: actions/upload-artifact@v4
        with:
          name: opencog-package-definition
          path: opencog.scm
          retention-days: 90

      - name: Build summary
        run: |
          echo "## ðŸŽ‰ Build Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Path**: \`${{ steps.build_output.outputs.build_path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Git Commit**: \`${GITHUB_SHA:0:7}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Run**: #${GITHUB_RUN_NUMBER}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Caching Enabled" >> $GITHUB_STEP_SUMMARY
          echo "Dependencies and build outputs are cached for faster future builds." >> $GITHUB_STEP_SUMMARY
          echo "Cache key: \`guix-store-${{ runner.os }}-${{ hashFiles('opencog.scm') }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Generated" >> $GITHUB_STEP_SUMMARY
          echo "- **opencog-pack.tar.gz**: Package archive" >> $GITHUB_STEP_SUMMARY
          echo "- **opencog-package-definition.scm**: Original package definition" >> $GITHUB_STEP_SUMMARY
          echo "- **build-info.txt**: Build metadata" >> $GITHUB_STEP_SUMMARY
          echo "- **package-info.txt**: Package information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifact Sizes" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh artifacts/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Download artifacts from the workflow run page." >> $GITHUB_STEP_SUMMARY
