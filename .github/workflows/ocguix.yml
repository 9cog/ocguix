# OpenCog Guix Package Build with Auto-Sync to Repository

name: ocguix

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  ocguix:

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug - List repository files
        run: |
          echo "Current directory:"
          pwd
          echo "Files in current directory:"
          ls -la
          echo "Checking for opencog.scm:"
          ls -l opencog.scm || echo "opencog.scm not found"

      - name: Cache local build directory
        uses: actions/cache@v4
        with:
          path: |
            build/
            .guix-profile/
          key: ocguix-build-${{ runner.os }}-${{ hashFiles('opencog.scm') }}
          restore-keys: |
            ocguix-build-${{ runner.os }}-

      - name: Cache Guix store
        uses: actions/cache@v4
        with:
          path: |
            /var/guix
            ~/.cache/guix
          key: guix-store-${{ runner.os }}-${{ hashFiles('opencog.scm') }}
          restore-keys: |
            guix-store-${{ runner.os }}-

      - name: Install GNU Guix
        run: |
          sudo apt-get update
          sudo apt-get install -y guix
          
          # Display Guix version
          guix --version
          
          # Initialize Guix if needed
          sudo mkdir -p /var/guix
          sudo chown -R $USER:$USER /var/guix || true

      - name: Setup local build directory
        run: |
          echo "Setting up local build directory..."
          mkdir -p build
          mkdir -p .guix-profile
          
          # Check if we have cached builds
          if [ -d "build/opencog" ]; then
            echo "âœ“ Found cached build directory"
            ls -lh build/
          else
            echo "No cached build found, will build from scratch"
          fi

      - name: Restore Guix daemon state
        run: |
          echo "Checking Guix store state..."
          if [ -d "/var/guix/profiles" ]; then
            echo "âœ“ Guix store cache restored"
            du -sh /var/guix 2>/dev/null || echo "Unable to check size"
          else
            echo "No cache found, will download all dependencies"
          fi

      - name: Build OpenCog packages to local directory
        run: |
          echo "Building OpenCog package to local directory..."
          echo "This will download and cache all dependencies..."
          
          # Build the package and get the output path
          BUILD_OUTPUT=$(guix build -f opencog.scm)
          echo "Build output: $BUILD_OUTPUT"
          
          # Copy build output to local build directory
          mkdir -p build/opencog
          if [ -n "$BUILD_OUTPUT" ] && [ -d "$BUILD_OUTPUT" ]; then
            echo "Copying build output to build/opencog/..."
            cp -r "$BUILD_OUTPUT"/* build/opencog/ 2>/dev/null || rsync -av "$BUILD_OUTPUT/" build/opencog/
            echo "âœ“ Build copied to local directory"
          fi
          
          echo "Build completed successfully!"
          du -sh build/ 2>/dev/null || echo "Build directory size: N/A"

      - name: Create local Guix profile
        run: |
          echo "Creating local Guix profile..."
          
          # Install to local profile
          guix package -f opencog.scm -p .guix-profile/opencog-profile || echo "Profile creation skipped"
          
          if [ -f ".guix-profile/opencog-profile" ]; then
            echo "âœ“ Local profile created"
            ls -lh .guix-profile/
          fi

      - name: Display build statistics
        run: |
          echo "=== Build Statistics ==="
          echo ""
          echo "Local build directory:"
          du -sh build/ 2>/dev/null || echo "N/A"
          echo ""
          echo "Local Guix profile:"
          du -sh .guix-profile/ 2>/dev/null || echo "N/A"
          echo ""
          echo "Guix store:"
          du -sh /var/guix 2>/dev/null || echo "N/A"
          echo ""
          echo "Files in build directory:"
          find build/ -type f 2>/dev/null | wc -l || echo "0"

      - name: Create .gitignore for build artifacts
        run: |
          # Create/update .gitignore to exclude large binary files but keep structure
          cat > build/.gitignore << 'EOF'
          # Keep directory structure but ignore some large files
          *.so
          *.a
          *.o
          __pycache__/
          *.pyc
          EOF
          
          # Don't ignore everything - we want to commit the build
          echo "âœ“ Created build/.gitignore"

      - name: Commit and push build directory to repository
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "Configuring git..."
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Configure git to use the PAT
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          echo "Checking for changes..."
          git add build/ .guix-profile/ || true
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            echo "Committing build directory..."
            git commit -m "chore: Update build directory [skip ci]

          Auto-generated by workflow run #${{ github.run_number }}
          Commit: ${{ github.sha }}
          
          Build statistics:
          - Build directory: $(du -sh build/ 2>/dev/null | cut -f1 || echo 'N/A')
          - Profile: $(du -sh .guix-profile/ 2>/dev/null | cut -f1 || echo 'N/A')
          - Files: $(find build/ -type f 2>/dev/null | wc -l || echo '0')"
            
            echo "Pushing to repository..."
            git push origin main || echo "Push failed, may need manual intervention"
            echo "âœ“ Build directory committed and pushed to repository"
          fi

      - name: Export package manifest
        run: |
          echo "Exporting package manifest..."
          guix package --export-manifest > opencog-manifest.scm || echo "specifications->manifest" > opencog-manifest.scm
          echo "Manifest content:"
          cat opencog-manifest.scm

      - name: Create artifacts from local build
        run: |
          echo "Creating artifacts from local build directory..."
          mkdir -p artifacts
          
          # Create tarball from local build directory
          if [ -d "build/opencog" ] && [ "$(ls -A build/opencog)" ]; then
            echo "Packaging build/opencog/..."
            tar -czf artifacts/opencog-pack.tar.gz -C build opencog
            echo "âœ“ Created opencog-pack.tar.gz"
          else
            echo "No build output found, creating placeholder"
            echo "OpenCog build output not available" > artifacts/README.txt
            tar -czf artifacts/opencog-pack.tar.gz -C artifacts README.txt
          fi
          
          # Also create a tarball of the Guix profile if it exists
          if [ -d ".guix-profile" ] && [ "$(ls -A .guix-profile)" ]; then
            echo "Packaging Guix profile..."
            tar -czf artifacts/opencog-profile.tar.gz .guix-profile
            echo "âœ“ Created opencog-profile.tar.gz"
          fi
          
          ls -lh artifacts/

      - name: Generate build info
        run: |
          echo "Generating build information..."
          
          # Get git status for build directory
          BUILD_COMMITTED="No"
          if git log -1 --pretty=format:"%s" | grep -q "Update build directory"; then
            BUILD_COMMITTED="Yes (committed to repository)"
          fi
          
          cat > artifacts/build-info.txt << EOF
          OpenCog Guix Package Build
          ==========================
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Git Commit: ${GITHUB_SHA}
          Git Branch: ${GITHUB_REF#refs/heads/}
          Workflow Run: ${GITHUB_RUN_NUMBER}
          Runner OS: $(uname -a)
          
          Local Build Directory: ./build/opencog/
          Local Guix Profile: ./.guix-profile/
          Build Committed to Repo: ${BUILD_COMMITTED}
          
          Build Statistics:
          -----------------
          Build directory size: $(du -sh build/ 2>/dev/null | cut -f1 || echo "N/A")
          Profile size: $(du -sh .guix-profile/ 2>/dev/null | cut -f1 || echo "N/A")
          Total files: $(find build/ -type f 2>/dev/null | wc -l || echo "0")
          
          Guix Version:
          -------------
          $(guix --version)
          
          Build Command Used:
          ------------------
          guix build -f opencog.scm
          guix package -f opencog.scm -p .guix-profile/opencog-profile
          
          Storage Strategy:
          ----------------
          âœ“ Build directory saved to repository (./build/)
          âœ“ Automatically committed and pushed after successful build
          âœ“ Local Guix profile cached (./.guix-profile/)
          âœ“ Guix store cached (/var/guix)
          âœ“ All dependencies cached for future runs
          
          Package Definition:
          ------------------
          See opencog-package-definition.scm in artifacts
          EOF
          cat artifacts/build-info.txt

      - name: Copy files to artifacts
        run: |
          cp opencog-manifest.scm artifacts/ 2>/dev/null || echo "No manifest to copy"
          cp opencog.scm artifacts/opencog-package-definition.scm
          
          # Try to get package info
          guix package --show=opencog > artifacts/package-info.txt 2>&1 || echo "Package info not available via guix package --show" > artifacts/package-info.txt
          
          # Copy a sample of build directory structure
          if [ -d "build/opencog" ]; then
            echo "Build directory structure:" > artifacts/build-structure.txt
            tree -L 3 build/ >> artifacts/build-structure.txt 2>/dev/null || find build/ -maxdepth 3 -type d >> artifacts/build-structure.txt
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: opencog-guix-packages
          path: |
            artifacts/
          retention-days: 90
          compression-level: 9

      - name: Upload local build directory
        uses: actions/upload-artifact@v4
        with:
          name: opencog-local-build
          path: |
            build/
          retention-days: 30
          compression-level: 6

      - name: Upload package definition separately
        uses: actions/upload-artifact@v4
        with:
          name: opencog-package-definition
          path: opencog.scm
          retention-days: 90

      - name: Build summary
        run: |
          echo "## ðŸŽ‰ Build Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Local Build Directory**: \`./build/opencog/\` (committed to repo)" >> $GITHUB_STEP_SUMMARY
          echo "- **Local Guix Profile**: \`./.guix-profile/\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Git Commit**: \`${GITHUB_SHA:0:7}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Run**: #${GITHUB_RUN_NUMBER}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Auto-Sync Enabled" >> $GITHUB_STEP_SUMMARY
          echo "Build directory is automatically committed and pushed to the repository!" >> $GITHUB_STEP_SUMMARY
          echo "- Check the \`build/\` directory in the repository for built packages" >> $GITHUB_STEP_SUMMARY
          echo "- Future builds will reuse existing build outputs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Multi-Layer Caching" >> $GITHUB_STEP_SUMMARY
          echo "1. **Repository storage** (\`./build/\`) - Committed and pushed automatically" >> $GITHUB_STEP_SUMMARY
          echo "2. **GitHub Actions cache** - Build directory and profile cached" >> $GITHUB_STEP_SUMMARY
          echo "3. **Guix store cache** (\`/var/guix\`) - Dependencies cached" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts Generated" >> $GITHUB_STEP_SUMMARY
          echo "- **opencog-pack.tar.gz**: Package archive from local build" >> $GITHUB_STEP_SUMMARY
          echo "- **opencog-profile.tar.gz**: Guix profile archive" >> $GITHUB_STEP_SUMMARY
          echo "- **opencog-local-build**: Complete build directory (separate artifact)" >> $GITHUB_STEP_SUMMARY
          echo "- **opencog-package-definition.scm**: Original package definition" >> $GITHUB_STEP_SUMMARY
          echo "- **build-info.txt**: Build metadata and statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifact Sizes" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh artifacts/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ Download artifacts or check the \`build/\` directory in the repository." >> $GITHUB_STEP_SUMMARY
